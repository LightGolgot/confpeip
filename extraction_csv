import csv
import math

"""
EXTRACTION DES DONNEES DE PLUVIOMETRIE
On utilise ce dataset comme source : https://www.data.gouv.fr/fr/datasets/pluviometrie/

Les données sont celles des Hauts-de-Seine, j'ai choisis arbitrairement les données d'Asnière
puisque c'est à côté de chez moi à Paris (on peut changer via le premier argument de get_csv).

La valeure de la pluviométrie est en mm/m^3 habituellement, on doit donc rentrer le diamètre du pot de
la plante pour trouver la quantité.

La notice finale garde les dates comme elles le sont dans le CSV d'origine, je corrigerais après en avoir
discuter avec gauthier.

PS : excusez moi d'avance pour l'optimisation du programme qui est surement désastreuse :o
"""

class pluviometrie:
    def __init__(self, c, diametre):
        self.rows = []
        self.header = []
        self.surface = math.pi * diametre**2
        self.months = ['janvier', 'février', 'mars', 'avril', 'mai', 'juin', 'juillet', 'août', 'septembre', 'octobre', 'novembre', 'décembre']
        with open(c, 'r') as file:
            csvreader = csv.reader(file, delimiter=';')
            self.header = next(csvreader)
            for row in csvreader:
                self.rows.append(row)

    def date(self, s):
        a = s[0:4]
        m = s[5:7]
        j = s[8:10]
        return [int(a), int(m), int(j)]

    def read_date(self, s):

        a = s[0]
        m = self.months[s[1]]
        j = s[2]
        d = str(j) + ' ' + str(m)
        print(d)
        return d

    def crop(self, R, y):
        return [r for r in R if r[0][0] == y]

    def get_rain_from_row(self, n):
        R = []
        for r in self.rows:
            R.append([self.date(r[0]),r[n]])
        return R

    def set_readable_date(self, R):
        for r in R:
            print(r[0])
            r[0] = self.read_date(r[0])
        return R

    def quantity(self, r):
        return float(r[1])*self.surface

    def add_quantity(self, R):
        for i in range(len(R)):
            T = R[i]
            T.append(self.quantity(R[i]))
            R[i] = T
        return R

    def get_csv(self, n, y, c):
        R = self.get_rain_from_row(n)
        R = self.crop(R,y)
        R = self.set_readable_date(R)
        R = self.add_quantity(R)
        print(R)
        header = ['date', 'pluviométrie', 'quantité en mL']
        with open(c, 'w') as file:
            csvwriter = csv.writer(file, delimiter=';')
            csvwriter.writerow(header)
            csvwriter.writerows(R)
            file.close()
        print('fichier écrit avec succès !')


data = pluviometrie('dataset/pluviometrie.csv', 0.175)
data.get_csv(4, 2022, 'dataset/notice1.csv')
